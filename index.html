<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Suhba Chat</title>

  <!-- Tailwind CSS (via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .chat-container {
      max-width: 800px;
      width: 100%;
    }
    .message-container {
      height: 60vh;
    }
  </style>
</head>

<body class="bg-black text-white flex items-center justify-center min-h-screen">
<!-- Username Prompt -->
<div id="namePrompt" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
  <div class="bg-gray-800 p-6 rounded-lg text-center space-y-4">
    <h2 class="text-2xl font-bold">Enter your name</h2>
    <input type="text" id="usernameInput" class="p-3 rounded-lg bg-gray-700 text-white w-full" placeholder="Your name..." />
    <button onclick="saveName()" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Join Chat</button>
  </div>
</div>
<div id="onlineUsers" class="text-sm text-gray-400 mb-2"></div>

  <!-- Chat App Container -->
  <div class="chat-container bg-gray-900 p-6 rounded-lg shadow-lg">
    <h2 class="text-3xl font-semibold text-center mb-6">Suhba Chat</h2>

    <!-- Messages Area -->
    <div id="messages" class="message-container bg-gray-800 p-4 rounded-lg overflow-y-auto mb-4">
      <!-- Messages will appear here -->
    </div>

    <!-- Input Area -->
    <div class="flex items-center space-x-2">
      <input type="text" id="msgInput" class="flex-grow p-3 bg-gray-700 text-white rounded-lg" placeholder="Type a message..." />
      <button id="sendBtn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-semibold">
        Send
      </button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjzZbIR59C-_xFvV043rd2PXIM6IA5Kv4",
      authDomain: "suhbachat.firebaseapp.com",
      projectId: "suhbachat",
      storageBucket: "suhbachat.firebasestorage.app",
      messagingSenderId: "1013393597517",
      appId: "1:1013393597517:web:3d4862bb677a0d358e6804",
      measurementId: "G-8242K26MKS"
    };
    const usersRef = db.collection("users");
let currentUser = null;

  
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const messagesDiv = document.getElementById("messages");
  
    // Prompt user for name
    const namePrompt = document.getElementById("namePrompt");
    const usernameInput = document.getElementById("usernameInput");
  
    async function saveName() {
  const name = usernameInput.value.trim();
  if (!name) return;

  const userDoc = await usersRef.doc(name).get();
  if (userDoc.exists) {
    alert("Username already taken! Try something else.");
    return;
  }

  currentUser = name;
  localStorage.setItem("suhbaUsername", name);
  namePrompt.style.display = "none";

  // Save user online status + timestamp
  await usersRef.doc(name).set({
    lastActive: firebase.firestore.FieldValue.serverTimestamp()
  });

  startUserHeartbeat(); // keep updating timestamp
}

  
    function sendMessage() {
      const text = msgInput.value.trim();
      const sender = localStorage.getItem("suhbaUsername");
      if (text !== "" && sender) {
        db.collection("messages").add({
          text: text,
          sender: sender,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          msgInput.value = "";
          msgInput.focus();
        }).catch(error => {
          console.error("Error sending message:", error);
        });
      }
    }
  
    sendBtn.onclick = sendMessage;
  
    msgInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
  
    // Real-time message listener
    db.collection("messages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("mb-3");
  
          const sender = document.createElement("div");
          sender.textContent = data.sender || "Anonymous";
          sender.classList.add("text-sm", "text-blue-400", "font-semibold");
  
          const message = document.createElement("div");
          message.textContent = data.text;
          message.classList.add("text-white");
  
          msgDiv.appendChild(sender);
          msgDiv.appendChild(message);
          messagesDiv.appendChild(msgDiv);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

    // Real-time online users display
usersRef.onSnapshot(snapshot => {
  const now = Date.now();
  const onlineHTML = [];

  snapshot.forEach(doc => {
    const data = doc.data();
    const name = doc.id;
    const lastActive = data.lastActive?.toDate();

    if (lastActive && now - lastActive.getTime() <= 2 * 60 * 1000) { // 2 mins
      const timeString = lastActive.toLocaleTimeString();
      onlineHTML.push(`<span class="mr-4">ðŸŸ¢ ${name} <span class="text-xs">(${timeString})</span></span>`);
    }
  });

  document.getElementById("onlineUsers").innerHTML = onlineHTML.join(" ");
});

    
    function startUserHeartbeat() {
  setInterval(() => {
    if (currentUser) {
      usersRef.doc(currentUser).update({
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }, 30000); // every 30 seconds
}

  </script>
  
</body>
</html>
